# 環境の構成を把握する

パフォーマンスのモニタリングを開始する前に
- 情報を取得する対象の環境の構成を把握する

ことから始める必要があります。  
ここでいう環境の構成ですが、細かな構成ではなく、次のような内容を指しています。

- CPU のソケット数 / コア数
- 搭載されているメモリサイズ
- ディスクの基本性能
- 利用可能なネットワークの帯域
- SQL Server 専用の環境か否か

当然の話ではありますが、ハードウェアの性能以上、性能を出すことはできませんので、環境がどのようなハードウェアで構成されているかを最初に把握する必要があります。

CPU の情報 / メモリサイズ / ネットワーク帯域については、ハードウェアの構成を確認することで把握することができますので、これらの情報の取得については難しい話ではないと思います。

「ディスクの基本性能」については、環境の構築直後や、同一の構成 (RAID / ディスク本数 / ディスクの種類 (SAS / SATA / SSD / 回転数 等)) が、他にない場合は、取得するのが難しいかもしれませんが、論理値でもよいので情報が取得することができるかは検討した方が良いと考えています。

データベースサーバーの場合、
- メモリ上にないデータへのアクセス
- データの変更処理の発生によるトランザクションログへのログレコードの書き込み
- チェックポイント時にデータファイルに、メモリ上の変更データを書き込み

というようなディスクアクセスが発生します。  

では、上記のようなディスクアクセスが発生した場合に、「500MB/sec」のディスクアクセスが発生していたとして、これは問題でしょうか？  

これが問題かどうかは次のような観点での確認が必要になります。
- ディスクキューの発生が確認でき、ディスクの処理要求の待ちが発生している
- ディスクの「基本性能以上」の I/O 要求が発生している

ディスクキューが発生していることで、I/O 待ちの要求があることは確認することができますが、それが「なぜ発生したのか?」については、ディスクの基本性能の情報も必要となってきます。  
ディスクの基本性能以上のアクセスは発生させることはできませんので、
- 「xxx MB/sec, xxx IOPS の要求」が発生しており、この要求は、ディスクの基本性能以上のため、ディスクキューが発生した

というような結論を得るための材料として「ディスクの基本性能」の情報が必要となります。

もし、モニタリングの対象と類似の環境が準備できるのであれば [diskspd](https://aka.ms/diskspd "diskspd") のようなツールを使用して、ディスクの基本性能を取得することを検討してください。  
これにより取得された情報が、「ディスクで発生させることができる性能上限」となります。  
取得した基本性能とモニタリングで取得したディスクのアクセス状況を比較することで「ディスクの性能に余裕があるのか否か」を判断することができます。  

ディスクにアクセスされることが一番の問題なのではなく (本当はすべてオンメモリ / インメモリで処理したいですが)、「ディスクの性能以上の I/O が発生している」ことが一番の問題ですので。  
ディスクのアクセスが発生していたとしても、それがディスクの性能内なのであれば、そのディスクアクセスは許容できる可能性があるということを念頭に置く必要があります。

同様のことはネットワークにも言えます。  
SQL Server でネットワークを使用する代表的な例としては、
- データを SQL Server のアクセス元にネットワーク経由で返す必要がある
- バックアップをネットワーク越しで別の環境に取得している

というようなものがありますが、これらのアクセスも「ネットワークの帯域上限以上」はスループットを出すことはできませんので。  
(アクセス元に返すデータの件数を減らす / バックアップを圧縮することで転送データを減らすということも検討する必要はありますが)

SQL Server の専用環境かどうかについては、プロセスの情報を見ることで確認することができますが、ヒアリングの段階で確認することができるのであれば、事前に確認してもよいかと思います。
SQL Server 専用の環境ではない場合、モニタリングで取得した情報を確認した結果、「SQL Server 以外のプロセスが負荷を上げている原因だった」ということもあり得ますので。

正しく情報を読み解くためには、
- そもそもとして、その環境はどれだけの性能が出せる環境なのか？

を、きちんと把握しておくことが重要です。

[インデックスに戻る](../readme.md "インデックスに戻る")